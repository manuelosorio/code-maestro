## This file is generated by Nx.
## This file is generated by Nx.
##
## Build the docker image with `npx nx docker-build main-app`.
## Tip: Modify "docker-build" options in project.json to change docker build args.
##
## Run the container with `docker run -p 3000:3000 -t main-app`.
FROM node:21.6.1-slim
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable


ENV HOST=0.0.0.0
ENV PORT=4100

WORKDIR /app

EXPOSE 4100
EXPOSE 4101

RUN apt update && apt install -y curl

RUN addgroup --system main-app &&  \
    adduser --system --ingroup main-app main-app

COPY . .
RUN chown -R main-app:main-app .
RUN chmod +x ./startup.sh
RUN pnpm add -g nx@17.2.8 @analogjs/platform@0.2.30 @nx-tools/nx-prisma@5.2.0 vite@5.0.12
RUN pnpm install

ENV NODE_ENV=production

RUN nx run main-app:build:production

CMD ["./startup.sh"]
